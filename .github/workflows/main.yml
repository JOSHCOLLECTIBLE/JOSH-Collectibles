name: JOSH Photography Bot
on:
  push:
    paths:
      - 'uploads/**'

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Photo to Telegram
        run: |
          FILE=$(ls -t uploads/ | grep -E '\.(jpg|jpeg|png|JPG|PNG|gif)$' | head -1)
          if [ -z "$FILE" ]; then
            echo "No image found"
            exit 1
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
            -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -F photo="@uploads/$FILE" \
            -F caption="ðŸ”¥ NEW JOSH COLLECTIBLE DROP ðŸ”¥ Check it out on Instagram: https://instagram.com/joshuadenouden"

      - name: Cleanup Uploads Folder
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          rm -rf uploads/*
          touch uploads/.gitkeep
          git add uploads/
          git commit -m "Cleanup after drop"
          git push
